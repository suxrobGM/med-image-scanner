"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[1169],{31169:(e,t,n)=>{n.r(t),n.d(t,{default:()=>$});var r=n(43001),i=n(7023),a=n(3827),o=n.n(a),s=n(93725),l=n(12651),c=n(84793),m=n(38604),u=n(13e3);function p({viewportData:e,viewportId:t,element:n,imageSliceData:i,setImageSliceData:a,scrollbarHeight:o,servicesManager:c}){const{cineService:u,cornerstoneViewportService:p}=c.services;return(0,r.useEffect)((()=>{if(!e)return;const n=p.getCornerstoneViewport(t);if(n)if(e.viewportType!==l.Enums.ViewportType.STACK){if(e.viewportType===l.Enums.ViewportType.ORTHOGRAPHIC){const e=l.utilities.getImageSliceDataForVolumeViewport(n);if(!e)return;const{imageIndex:t,numberOfSlices:r}=e;a({imageIndex:t,numberOfSlices:r})}}else{const t=n.getCurrentImageIdIndex();a({imageIndex:t,numberOfSlices:e.data[0].imageIds.length})}}),[t,e]),(0,r.useEffect)((()=>{if(e?.viewportType!==l.Enums.ViewportType.STACK)return;const t=t=>{const{newImageIdIndex:n}=t.detail;a({imageIndex:n,numberOfSlices:e.data[0].imageIds.length})};return n.addEventListener(l.Enums.Events.STACK_VIEWPORT_SCROLL,t),()=>{n.removeEventListener(l.Enums.Events.STACK_VIEWPORT_SCROLL,t)}}),[e,n]),(0,r.useEffect)((()=>{if(e?.viewportType!==l.Enums.ViewportType.ORTHOGRAPHIC)return;const t=e=>{const{imageIndex:t,numberOfSlices:n}=e.detail;a({imageIndex:t,numberOfSlices:n})};return n.addEventListener(l.Enums.Events.VOLUME_NEW_IMAGE,t),()=>{n.removeEventListener(l.Enums.Events.VOLUME_NEW_IMAGE,t)}}),[e,n]),r.createElement(m.Ln,{onChange:e=>((e,t)=>{const r=p.getCornerstoneViewport(t),{isCineEnabled:i}=u.getState();i&&(u.stopClip(n,{viewportId:t}),u.setCine({id:t,isPlaying:!1})),s.utilities.jumpToSlice(r.element,{imageIndex:e,debounceLoading:!0})})(e,t),max:i.numberOfSlices?i.numberOfSlices-1:0,height:o,value:i.imageIndex})}p.propTypes={viewportData:o().object,viewportId:o().string.isRequired,element:o().instanceOf(Element),scrollbarHeight:o().string,imageSliceData:o().object.isRequired,setImageSliceData:o().func.isRequired,servicesManager:o().object.isRequired};const d=p;var g=n(34),v=n(33901),f=n.n(v),E=n(72076);const{getOrientationStringLPS:w,invertOrientationStringLPS:I}=s.utilities.orientation;const y=function({element:e,viewportData:t,imageSliceData:n,viewportId:i,servicesManager:a,orientationMarkers:o=["top","left"]}){const[s,c]=(0,r.useState)(0),[m,u]=(0,r.useState)(!1),[p,d]=(0,r.useState)(!1),{cornerstoneViewportService:g}=a.services;(0,r.useEffect)((()=>{const t=e=>{const{rotation:t,previousCamera:n,camera:r}=e.detail;void 0!==t&&c(t),void 0!==r.flipHorizontal&&n.flipHorizontal!==r.flipHorizontal&&u(r.flipHorizontal),void 0!==r.flipVertical&&n.flipVertical!==r.flipVertical&&d(r.flipVertical)};return e.addEventListener(l.Enums.Events.CAMERA_MODIFIED,t),()=>{e.removeEventListener(l.Enums.Events.CAMERA_MODIFIED,t)}}),[]);const v=(0,r.useMemo)((()=>{if(!t)return"";let a,c,u;if("stack"===t.viewportType){const e=n.imageIndex,r=t.data[0].imageIds?.[e];if(!r)return!1;({rowCosines:a,columnCosines:c,isDefaultValueSetForColumnCosine:u,isDefaultValueSetForColumnCosine:u}=l.metaData.get("imagePlaneModule",r)||{})}else{if(!e||!(0,l.getEnabledElement)(e))return"";const{viewport:t}=(0,l.getEnabledElement)(e),{viewUp:n,viewPlaneNormal:r}=t.getCamera(),i=E.R3.create();E.R3.cross(i,n,r),c=[-n[0],-n[1],-n[2]],a=i}if(!a||!c||void 0===s||u)return"";const d=function(e,t,n,r,i){const a=w(e),o=w(t),s=I(a),l={top:I(o),left:s,right:a,bottom:o};r&&(l.top=I(l.top),l.bottom=I(l.bottom));i&&(l.left=I(l.left),l.right=I(l.right));if(90===n||-270===n)return{top:l.left,left:I(l.top),right:I(l.bottom),bottom:l.right};if(-90===n||270===n)return{top:I(l.left),left:l.top,bottom:l.left,right:l.bottom};if(180===n||-180===n)return{top:I(l.top),left:I(l.left),bottom:I(l.bottom),right:I(l.right)};return l}(a,c,s,p,m);return g.getViewportInfo(i)?o.map(((e,t)=>r.createElement("div",{className:f()("overlay-text",`${e}-mid orientation-marker`,"text-aqua-pale","text-[13px]","leading-5"),key:`${e}-mid orientation-marker`},r.createElement("div",{className:"orientation-marker-value"},d[e])))):(console.log("ViewportOrientationMarkers::No viewport"),null)}),[t,n,s,p,m,o,e]);return r.createElement("div",{className:"ViewportOrientationMarkers select-none"},v)};function S({viewportData:e,element:t}){const[n,i]=(0,r.useState)(!1),[a,o]=(0,r.useState)(!1),s=(0,r.useRef)(null),c=(0,r.useRef)(null),m=e=>{clearTimeout(s.current),s.current=setTimeout((()=>{i(!0)}),50)},u=e=>{clearTimeout(s.current),i(!1)},p=e=>{clearTimeout(s.current),c.current===e.detail.imageId&&(o(e.detail.error),c.current=null)};return(0,r.useEffect)((()=>(t.addEventListener(l.Enums.Events.STACK_VIEWPORT_SCROLL,m),t.addEventListener(l.Enums.Events.IMAGE_LOAD_ERROR,p),t.addEventListener(l.Enums.Events.STACK_NEW_IMAGE,u),()=>{t.removeEventListener(l.Enums.Events.STACK_VIEWPORT_SCROLL,m),t.removeEventListener(l.Enums.Events.STACK_NEW_IMAGE,u),t.removeEventListener(l.Enums.Events.IMAGE_LOAD_ERROR,p)})),[t,e]),a?r.createElement(r.Fragment,null,r.createElement("div",{className:"absolute top-0 left-0 h-full w-full bg-black opacity-50"},r.createElement("div",{className:"transparent flex h-full w-full items-center justify-center"},r.createElement("p",{className:"text-primary-light text-xl font-light"},r.createElement("h4",null,"Error Loading Image"),r.createElement("p",null,"An error has occurred."),r.createElement("p",null,a))))):n?r.createElement("div",{className:"pointer-events-none absolute top-0 left-0 h-full w-full bg-black opacity-50"},r.createElement("div",{className:"transparent flex h-full w-full items-center justify-center"},r.createElement("p",{className:"text-primary-light text-xl font-light"},"Loading..."))):null}S.propTypes={error:o().object,element:o().object};const b=S;const h=function(e){const{viewportId:t,element:n,scrollbarHeight:i,servicesManager:a}=e,{cornerstoneViewportService:o}=a.services,[s,l]=(0,r.useState)({imageIndex:0,numberOfSlices:0}),[c,m]=(0,r.useState)(null);if((0,r.useEffect)((()=>{const{unsubscribe:e}=o.subscribe(o.EVENTS.VIEWPORT_DATA_CHANGED,(e=>{e.viewportId===t&&m(e.viewportData)}));return()=>{e()}}),[t]),!n)return null;if(c){const e=o.getViewportInfo(t);if(e?.viewportOptions?.customViewportProps?.hideOverlays)return null}return r.createElement("div",{className:"noselect"},r.createElement(d,{viewportId:t,viewportData:c,element:n,imageSliceData:s,setImageSliceData:l,scrollbarHeight:i,servicesManager:a}),r.createElement(g.ZP,{imageSliceData:s,viewportData:c,viewportId:t,servicesManager:a,element:n}),r.createElement(b,{viewportData:c,element:n}),r.createElement(y,{imageSliceData:s,element:n,viewportData:c,servicesManager:a,viewportId:t}))};var C=n(90927),x=n(15793),M=n(52490);function V({viewportId:e,cineService:t,newStackFrameRate:n,isPlaying:i,dynamicInfo:a,customizationService:o}){const{component:s=m.H6}=o.get("cinePlayer")??{},[c,u]=(0,r.useState)(a);(0,r.useEffect)((()=>{u(a)}),[a]),(0,r.useEffect)((()=>{if(!c)return;const e=e=>{const{volumeId:t,timePointIndex:n,numTimePoints:r,splittingTag:i}=e.detail;u({volumeId:t,timePointIndex:n,numTimePoints:r,label:i})};return l.eventTarget.addEventListener(x.Yb.z.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED,e),()=>{l.eventTarget.removeEventListener(x.Yb.z.DYNAMIC_VOLUME_TIME_POINT_INDEX_CHANGED,e)}}),[c]),(0,r.useEffect)((()=>{if(!c)return;const{volumeId:e,timePointIndex:t,numTimePoints:n,splittingTag:r}=c||{};l.cache.getVolume(e).timePointIndex=t,u({volumeId:e,timePointIndex:t,numTimePoints:n,label:r})}),[]);const p=(0,r.useCallback)((e=>{const{volumeId:t,timePointIndex:n}=e;l.cache.getVolume(t).timePointIndex=n}),[]);return r.createElement(s,{className:"absolute left-1/2 bottom-3 -translate-x-1/2",frameRate:n,isPlaying:i,onClose:()=>{t.setCine({id:e,isPlaying:!1}),t.setIsCineEnabled(!1)},onPlayPauseChange:n=>{t.setCine({id:e,isPlaying:n})},onFrameRateChange:n=>t.setCine({id:e,frameRate:n}),dynamicInfo:c,updateDynamicInfo:p})}const T=function({enabledVPElement:e,viewportId:t,servicesManager:n}){const{customizationService:i,displaySetService:a,viewportGridService:o}=n.services,[{isCineEnabled:s,cines:c},u]=(0,m.vQ)(),[p,d]=(0,r.useState)(24),[g,v]=(0,r.useState)(null),[f]=(0,M.M)(),E=(0,r.useRef)(null),w=()=>{if(!c?.[t]||!e)return;const{isPlaying:n=!1,frameRate:r=24}=c[t],i=Math.max(r,1);return n?u.playClip(e,{framesPerSecond:i,viewportId:t}):u.stopClip(e)},I=(0,r.useCallback)((()=>{if(!e||!s)return;const{viewports:n}=o.getState(),{displaySetInstanceUIDs:r}=n.get(t);let i=24,l=c[t]?.isPlaying||!1;r.forEach((e=>{const t=a.getDisplaySetByUID(e);if(t.FrameRate&&(i=Math.round(1e3/t.FrameRate),l||=!!f.autoPlayCine),t.isDynamicVolume){const{dynamicVolumeInfo:e}=t,n=e.timePoints.length,r=e.splittingTag,i=e.timePointIndex||0;v({volumeId:t.displaySetInstanceUID,timePointIndex:i,numTimePoints:n,label:r})}else v(null)})),l&&u.setIsCineEnabled(l),u.setCine({id:t,isPlaying:l,frameRate:i}),d(i)}),[a,t,o,c,s,e]);if((0,r.useEffect)((()=>(E.current=!0,I(),()=>{E.current=!1})),[s,I]),(0,r.useEffect)((()=>{s&&w()}),[s,w,e]),(0,r.useEffect)((()=>{if(e)return l.eventTarget.addEventListener(l.Enums.Events.STACK_VIEWPORT_NEW_STACK,I),e.addEventListener(l.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,I),()=>{u.setCine({id:t,isPlaying:!1}),l.eventTarget.removeEventListener(l.Enums.Events.STACK_VIEWPORT_NEW_STACK,I),e.removeEventListener(l.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,I)}}),[e,I,t]),(0,r.useEffect)((()=>{if(c&&c[t]&&e&&E.current)return w(),()=>{u.stopClip(e,{viewportId:t})}}),[c,t,u,e,w]),!s)return null;const y=c[t],S=y?.isPlaying||!1;return r.createElement(V,{viewportId:t,cineService:u,newStackFrameRate:p,isPlaying:S,dynamicInfo:g,customizationService:i})};var D=n(71645);const P=function({viewportId:e}){const[t]=(0,D.HC)();return t[e]?r.createElement(m.wq,{cornerComponents:t[e]}):null};var N=n(69190);function R({colormaps:e,viewportId:t,displaySets:n,commandsManager:i,servicesManager:a}){const{cornerstoneViewportService:o}=a.services,[s,c]=(0,r.useState)(n[0]),[u,p]=(0,r.useState)(!1),[d,g]=(0,r.useState)(null),v=(0,r.useRef)(u);v.current=u;const f=(0,r.useRef)(d);f.current=d;const E=(0,r.useRef)(s);E.current=s;const w=(0,r.useCallback)((e=>{const t=n.length>1&&!["Grayscale","X Ray"].includes(e.colormap.name)?.5:1;i.run({commandName:"setViewportColormap",commandOptions:{...e,opacity:t,immediate:!0},context:"CORNERSTONE"})}),[i]),I=(0,r.useMemo)((()=>n.map(((e,t)=>({children:e.Modality,key:t,style:{minWidth:`calc(100% / ${n.length})`,fontSize:"0.8rem",textAlign:"center",display:"flex",justifyContent:"center",alignItems:"center"}})))),[n]);return(0,r.useEffect)((()=>{c(n[n.length-1])}),[n]),r.createElement(r.Fragment,null,I.length>1&&r.createElement("div",{className:"all-in-one-menu-item flex w-full justify-center"},r.createElement(m.hE,{onActiveIndexChange:e=>{c(n[e]),g(null)},activeIndex:n.findIndex((e=>e.displaySetInstanceUID===E.current.displaySetInstanceUID))||1,className:"w-[70%] text-[10px]"},I.map((({children:e,key:t,style:n})=>r.createElement("div",{key:t,style:n},e))))),r.createElement("div",{className:"all-in-one-menu-item flex w-full justify-center"},r.createElement(m.U3,{label:"Preview in viewport",checked:u,onChange:e=>{p(e)}})),r.createElement(m.yZ.P7,null),r.createElement(m.yZ.qZ,null,e.map(((n,i)=>r.createElement(m.yZ.ck,{key:i,label:n.description,onClick:()=>{w({viewportId:t,colormap:n,displaySetInstanceUID:E.current.displaySetInstanceUID}),g(null)},onMouseEnter:()=>{v.current&&(g(((t,n)=>{const{displaySetInstanceUID:r}=n,i=o.getCornerstoneViewport(t);if(i instanceof l.StackViewport){const{colormap:t}=i.getProperties();return t||e.find((e=>"Grayscale"===e.Name))||e[0]}const a=i.getActors().find((e=>e.uid.includes(r))),{colormap:s}=i.getProperties(a.uid);return s||e.find((e=>"Grayscale"===e.Name))||e[0]})(t,E.current)),w({viewportId:t,colormap:n,displaySetInstanceUID:E.current.displaySetInstanceUID}))},onMouseLeave:()=>{v.current&&f.current&&w({viewportId:t,colormap:f.current,displaySetInstanceUID:E.current.displaySetInstanceUID})}})))))}function O(e,t,n,r,i){const{cornerstoneViewportService:a}=r.services,o=a.getCornerstoneViewport(e),s=a.getViewportInfo(e).getViewportOptions().background;!!s&&l.utilities.isEqual(s,[1,1,1])&&(i.ticks={position:"left",style:{font:"12px Arial",color:"#000000",maxNumTicks:8,tickSize:5,tickWidth:1,labelMargin:3}});const c=[];o instanceof l.StackViewport&&c.push(e),o instanceof l.VolumeViewport&&t.forEach((e=>{c.push(e.displaySetInstanceUID)})),n.run({commandName:"toggleViewportColorbar",commandOptions:{viewportId:e,options:i,displaySetInstanceUIDs:c},context:"CORNERSTONE"})}function k({viewportId:e,displaySets:t,commandsManager:n,servicesManager:i,colorbarProperties:a}){const{colorbarService:o}=i.services,{width:s,colorbarTickPosition:l,colorbarContainerPosition:c,colormaps:u,colorbarInitialColormap:p}=a,[d,g]=(0,r.useState)(o.hasColorbar(e)),v=(0,r.useCallback)((()=>{O(e,t,n,i,{viewportId:e,colormaps:u,ticks:{position:l},width:s,position:c,activeColormapName:p})}),[n]);return(0,r.useEffect)((()=>{const{unsubscribe:t}=o.subscribe(o.EVENTS.STATE_CHANGED,(()=>{g(o.hasColorbar(e))}));return()=>{t()}}),[e]),r.createElement("div",{className:"all-in-one-menu-item flex w-full justify-center"},r.createElement("div",{className:"mr-2 w-[28px]"}),r.createElement(m.U3,{label:"Display Color bar",checked:d,onChange:()=>{v()}}))}function L({viewportId:e,commandsManager:t,presets:n}){const{t:i}=(0,N.$G)("WindowLevelActionMenu"),a=(0,r.useCallback)((n=>{t.run({commandName:"setViewportWindowLevel",commandOptions:{...n,viewportId:e},context:"CORNERSTONE"})}),[t,e]);return r.createElement(m.yZ.qZ,null,n.map(((e,t)=>r.createElement(r.Fragment,{key:t},Object.entries(e).map((([e,t])=>r.createElement(r.Fragment,{key:e},r.createElement(m.yZ.Km,null,i("Modality Presets",{modality:e})),t.map(((t,n)=>r.createElement(m.yZ.ck,{key:`${e}-${n}`,label:t.description,secondaryLabel:`${t.window} / ${t.level}`,onClick:()=>a(t)}))))))))))}function A({presets:e,viewportId:t,commandsManager:n,onClose:i}){const[a,o]=(0,r.useState)(e),[s,l]=(0,r.useState)(""),[c,u]=(0,r.useState)(null),p=(0,r.useCallback)((t=>{l(t);const n=t?e.filter((e=>e.name.toLowerCase().includes(t.toLowerCase()))):e;o(n)}),[e]),d=(0,r.useCallback)((e=>{n.runCommand("setViewportPreset",{...e})}),[n]);return r.createElement("div",{className:"flex min-h-full w-full flex-col justify-between"},r.createElement("div",{className:"border-secondary-light h-[433px] w-full overflow-hidden rounded border bg-black px-2.5"},r.createElement("div",{className:"flex h-[46px] w-full items-center justify-start"},r.createElement("div",{className:"h-[26px] w-[200px]"},r.createElement(m.Xe,{value:s,onDebounceChange:p,placeholder:"Search all"}))),r.createElement("div",{className:"ohif-scrollbar overflow h-[385px] w-full overflow-y-auto"},r.createElement("div",{className:"grid grid-cols-4 gap-3 pt-2 pr-3"},a.map(((e,n)=>{return r.createElement("div",{key:n,className:"flex cursor-pointer flex-col items-start",onClick:()=>{u(e),d({preset:e.name,viewportId:t})}},r.createElement(m.JO,{name:e.name,className:c?.name===e.name?"border-primary-light h-[75px] w-[95px] max-w-none rounded border-2":"hover:border-primary-light h-[75px] w-[95px] max-w-none rounded border-2 border-black"}),r.createElement("label",{className:"text-aqua-pale mt-2 text-left text-xs"},(i=e.name,a=11,i.length>a?`${i.slice(0,a)}...`:i)));var i,a}))))),r.createElement("footer",{className:"flex h-[60px] w-full items-center justify-end"},r.createElement("div",{className:"flex"},r.createElement(m.zx,{name:"Cancel",size:m.LZ.dp.medium,type:m.LZ.dt.secondary,onClick:i}," ","Cancel"," "))))}function _({viewportId:e,servicesManager:t,commandsManager:n,volumeRenderingPresets:i}){const{uiModalService:a}=t.services;return r.createElement(m.yZ.ck,{label:"Rendering Presets",icon:r.createElement(m.JO,{name:"VolumeRendering"}),rightIcon:r.createElement(m.JO,{name:"action-new-dialog"}),onClick:()=>{a.show({content:A,title:"Rendering Presets",movable:!0,contentProps:{onClose:a.hide,presets:i,viewportId:e,commandsManager:n},containerDimensions:"h-[543px] w-[460px]",contentDimensions:"h-[493px] w-[460px]  pl-[12px] pr-[12px]"})}})}function U({volumeRenderingQualityRange:e,commandsManager:t,servicesManager:n,viewportId:i}){const{cornerstoneViewportService:a}=n.services,{min:o,max:s,step:l}=e,[c,m]=(0,r.useState)(null),u=(0,r.useCallback)((e=>{t.runCommand("setVolumeRenderingQulaity",{viewportId:i,volumeQuality:e}),m(e)}),[t,i]);return(0,r.useEffect)((()=>{const e=a.getCornerstoneViewport(i),{actor:t}=e.getActors()[0],n=t.getMapper(),r=n.getInputData().getSpacing(),o=n.getSampleDistance(),s=r.reduce(((e,t)=>e+t))/3;m(o===s?1:Math.sqrt(s/(.5*o)))}),[a,i]),r.createElement(r.Fragment,null,r.createElement("div",{className:"all-in-one-menu-item flex  w-full flex-row !items-center justify-between gap-[10px]"},r.createElement("label",{className:"block text-white",htmlFor:"volume"},"Quality"),null!==c&&r.createElement("input",{className:"bg-inputfield-main h-2 w-[120px] cursor-pointer appearance-none rounded-lg",value:c,id:"volume",max:s,min:o,type:"range",step:l,onChange:e=>u(parseInt(e.target.value,10)),style:{background:(e=>{const t=(e-0)/1*100;return`linear-gradient(to right, #5acce6 0%, #5acce6 ${t}%, #3a3f99 ${t}%, #3a3f99 100%)`})((c-o)/(s-o)),"--thumb-inner-color":"#5acce6","--thumb-outer-color":"#090c29"}})))}function G({viewportId:e,commandsManager:t,servicesManager:n}){const{cornerstoneViewportService:i}=n.services,[a,o]=(0,r.useState)(null),[s,l]=(0,r.useState)(null),[c,m]=(0,r.useState)(i.getCornerstoneViewport(e)?.shiftedBy||0),[u,p]=(0,r.useState)(null),[d,g]=(0,r.useState)(!1),v=(0,r.useRef)(c),f=i.getCornerstoneViewport(e),{actor:E}=f.getActors()[0],w=E.getProperty().getScalarOpacity(0);(0,r.useEffect)((()=>{if(d)return;const e=w.getRange(),t=e[1]-e[0],n=t;o(-t),l(n),p(Math.pow(10,Math.floor(Math.log10(t/500))))}),[i,e,E,w,d]);const I=(0,r.useCallback)((n=>{const r=n-v.current;v.current=n,f.shiftedBy=n,t.runCommand("shiftVolumeOpacityPoints",{viewportId:e,shift:r})}),[t,e,f]);return r.createElement(r.Fragment,null,r.createElement("div",{className:"all-in-one-menu-item flex  w-full flex-row !items-center justify-between gap-[10px]"},r.createElement("label",{className:"block  text-white",htmlFor:"shift"},"Shift"),null!==u&&r.createElement("input",{className:"bg-inputfield-main h-2 w-[120px] cursor-pointer appearance-none rounded-lg",value:c,onChange:e=>{const t=parseInt(e.target.value,10);m(t),I(t)},id:"shift",onMouseDown:()=>g(!0),onMouseUp:()=>g(!1),max:s,min:a,type:"range",step:u,style:{background:(e=>{const t=(e-0)/1*100;return`linear-gradient(to right, #5acce6 0%, #5acce6 ${t}%, #3a3f99 ${t}%, #3a3f99 100%)`})((c-a)/(s-a)),"--thumb-inner-color":"#5acce6","--thumb-outer-color":"#090c29"}})))}function W({servicesManager:e,commandsManager:t,viewportId:n}){const{cornerstoneViewportService:i}=e.services,[a,o]=(0,r.useState)(null),[s,l]=(0,r.useState)(null),[c,m]=(0,r.useState)(null),u=(0,r.useCallback)((()=>{t.runCommand("setVolumeLighting",{viewportId:n,options:{ambient:a}})}),[a,t,n]),p=(0,r.useCallback)((()=>{t.runCommand("setVolumeLighting",{viewportId:n,options:{diffuse:s}})}),[s,t,n]),d=(0,r.useCallback)((()=>{t.runCommand("setVolumeLighting",{viewportId:n,options:{specular:c}})}),[c,t,n]),g=e=>{const t=(e-0)/1*100;return`linear-gradient(to right, #5acce6 0%, #5acce6 ${t}%, #3a3f99 ${t}%, #3a3f99 100%)`};return(0,r.useEffect)((()=>{const e=i.getCornerstoneViewport(n),{actor:t}=e.getActors()[0],r=t.getProperty().getAmbient(),a=t.getProperty().getDiffuse(),s=t.getProperty().getSpecular();o(r),l(a),m(s)}),[n,i]),r.createElement(r.Fragment,null,r.createElement("div",{className:"all-in-one-menu-item flex  w-full flex-row !items-center justify-between gap-[10px]"},r.createElement("label",{className:"block  text-white",htmlFor:"ambient"},"Ambient"),null!==a&&r.createElement("input",{className:"bg-inputfield-main h-2 w-[120px] cursor-pointer appearance-none rounded-lg",value:a,onChange:e=>{o(e.target.value),u()},id:"ambient",max:1,min:0,type:"range",step:.1,style:{background:g(a),"--thumb-inner-color":"#5acce6","--thumb-outer-color":"#090c29"}})),r.createElement("div",{className:"all-in-one-menu-item flex  w-full flex-row !items-center justify-between gap-[10px]"},r.createElement("label",{className:"block  text-white",htmlFor:"diffuse"},"Diffuse"),null!==s&&r.createElement("input",{className:"bg-inputfield-main h-2 w-[120px] cursor-pointer appearance-none rounded-lg",value:s,onChange:e=>{l(e.target.value),p()},id:"diffuse",max:1,min:0,type:"range",step:.1,style:{background:g(s),"--thumb-inner-color":"#5acce6","--thumb-outer-color":"#090c29"}})),r.createElement("div",{className:"all-in-one-menu-item flex  w-full flex-row !items-center justify-between gap-[10px]"},r.createElement("label",{className:"block  text-white",htmlFor:"specular"},"Specular"),null!==c&&r.createElement("input",{className:"bg-inputfield-main h-2 w-[120px] cursor-pointer appearance-none rounded-lg",value:c,onChange:e=>{m(e.target.value),d()},id:"specular",max:1,min:0,type:"range",step:.1,style:{background:g(c),"--thumb-inner-color":"#5acce6","--thumb-outer-color":"#090c29"}})))}function j({commandsManager:e,viewportId:t,servicesManager:n}){const{cornerstoneViewportService:i}=n.services,[a,o]=(0,r.useState)(!0),[s,l]=(0,r.useState)(0),c=(0,r.useCallback)((n=>{e.runCommand("setVolumeLighting",{viewportId:t,options:{shade:n}})}),[e,t]);return(0,r.useEffect)((()=>{const e=i.getCornerstoneViewport(t),{actor:n}=e.getActors()[0],r=n.getProperty().getShade();o(r),l(s+1)}),[t,i]),r.createElement(m.U3,{key:s,label:"Shade",checked:a,onChange:()=>{o(!a),c(!a)}})}function H({viewportId:e,commandsManager:t,volumeRenderingQualityRange:n,servicesManager:i}){return r.createElement(m.yZ.qZ,null,r.createElement(U,{viewportId:e,commandsManager:t,servicesManager:i,volumeRenderingQualityRange:n}),r.createElement(G,{viewportId:e,commandsManager:t,servicesManager:i}),r.createElement("div",{className:"all-in-one-menu-item mt-2 flex !h-[20px] w-full justify-start"},r.createElement("div",{className:"text-aqua-pale text-[13px]"},"LIGHTING")),r.createElement("div",{className:"bg-primary-dark mt-1 mb-1 h-[2px] w-full"}),r.createElement("div",{className:"all-in-one-menu-item flex w-full justify-center"},r.createElement(j,{commandsManager:t,servicesManager:i,viewportId:e})),r.createElement(W,{viewportId:e,commandsManager:t,servicesManager:i}))}function F({viewportId:e,element:t,presets:n,verticalDirection:i,horizontalDirection:a,commandsManager:o,servicesManager:s,colorbarProperties:c,displaySets:u,volumeRenderingPresets:p,volumeRenderingQualityRange:d}){const{colormaps:g,colorbarContainerPosition:v,colorbarInitialColormap:E,colorbarTickPosition:w,width:I}=c,{colorbarService:y,cornerstoneViewportService:S}=s.services,b=S.getViewportInfo(e),h=S.getCornerstoneViewport(e),C=b.getViewportOptions().background,x=!!C&&l.utilities.isEqual(C,[1,1,1]),M=["SR","SEG","SM","RTSTRUCT","RTPLAN","RTDOSE"],{t:V}=(0,N.$G)("WindowLevelActionMenu"),[T]=(0,m.O_)(),{activeViewportId:D}=T,[P,A]=(0,r.useState)(t?.clientHeight),[U,G]=(0,r.useState)(0),[W,j]=(0,r.useState)(!1),F=(0,r.useCallback)((()=>{O(e,u,o,s,{colormaps:g,ticks:{position:w},width:I,position:v,activeColormapName:E})}),[o]);return(0,r.useEffect)((()=>{const e=t?.clientHeight;P!==e&&A(e)}),[t,P]),(0,r.useEffect)((()=>{y.hasColorbar(e)&&window.setTimeout((()=>{y.removeColorbar(e),F()}),0)}),[e,u,h]),(0,r.useEffect)((()=>{G(U+1);S.getCornerstoneViewport(e)instanceof l.VolumeViewport3D?j(!0):j(!1)}),[u,e,n,d,p,c,D,T]),r.createElement(m.yZ.dc,{icon:"viewport-window-level",verticalDirection:i,horizontalDirection:a,iconClassName:f()(D===e?"visible":"invisible group-hover:visible","flex shrink-0 cursor-pointer rounded active:text-white text-primary-light",x?" hover:bg-secondary-dark":"hover:bg-secondary-light/60"),menuStyle:{maxHeight:P-32,minWidth:218},onVisibilityChange:()=>{A(t.clientHeight)},menuKey:U},r.createElement(m.yZ.qZ,null,!W&&r.createElement(k,{viewportId:e,displaySets:u.filter((e=>!M.includes(e.Modality))),commandsManager:o,servicesManager:s,colorbarProperties:c}),g&&!W&&r.createElement(m.yZ.Wd,{key:"colorLUTPresets",itemLabel:"Color LUT",itemIcon:"icon-color-lut"},r.createElement(R,{colormaps:g,viewportId:e,displaySets:u.filter((e=>!M.includes(e.Modality))),commandsManager:o,servicesManager:s})),n&&n.length>0&&!W&&r.createElement(m.yZ.Wd,{key:"windowLevelPresets",itemLabel:V("Modality Window Presets"),itemIcon:"viewport-window-level"},r.createElement(L,{viewportId:e,commandsManager:o,presets:n})),p&&W&&r.createElement(_,{servicesManager:s,viewportId:e,commandsManager:o,volumeRenderingPresets:p}),d&&W&&r.createElement(m.yZ.Wd,{itemLabel:"Rendering Options"},r.createElement(H,{viewportId:e,commandsManager:o,volumeRenderingQualityRange:d,servicesManager:s}))))}let z;function Z(e,t){if(t.needsRerendering)return!1;if(e.displaySets.length!==t.displaySets.length)return!1;if(e.viewportOptions.orientation!==t.viewportOptions.orientation)return!1;if(e.viewportOptions.toolGroupId!==t.viewportOptions.toolGroupId)return!1;if(e.viewportOptions.viewportType!==t.viewportOptions.viewportType)return!1;if(t.viewportOptions.needsRerendering)return!1;const n=e.displaySets,r=t.displaySets;if(n.length!==r.length)return!1;for(let e=0;e<n.length;e++){const t=n[e],i=r.find((e=>e.displaySetInstanceUID===t.displaySetInstanceUID));if(!i)return!1;if(i.images?.length!==t.images?.length)return!1;if(i.images?.length)for(let e=0;e<i.images.length;e++)if(i.images[e].imageId!==t.images[e].imageId)return!1}return!0}const q=r.memo((e=>{const{displaySets:t,dataSource:n,viewportOptions:a,displaySetOptions:o,servicesManager:p,onElementEnabled:d,onElementDisabled:g,isJumpToMeasurementDisabled:v=!1,initialImageIndex:f,isHangingProtocolLayout:E}=e,w=a.viewportId;if(!w)throw new Error("Viewport ID is required");for(;o.length<t.length;)o.push({});a.viewportType=t.some((e=>e.isDynamicVolume&&e.isReconstructable))?"volume":a.viewportType;const[I,y]=(0,r.useState)("100px"),[S,b]=(0,r.useState)(null),C=(0,r.useRef)(),[x]=(0,M.M)(),{measurementService:V,displaySetService:D,toolbarService:N,toolGroupService:R,syncGroupService:O,cornerstoneViewportService:k,cornerstoneCacheService:L,viewportGridService:A,stateSyncService:_,viewportActionCornersService:U}=p.services,[G]=(0,m.en)(),W=(0,r.useCallback)((()=>{const e=C.current.clientHeight-40+"px";y(e)}),[C]),j=(0,r.useCallback)((()=>{C.current&&(k.resize(),W())}),[C]),H=(0,r.useCallback)((e=>{const t=e.getRenderingEngineId(),n=e.getSyncGroups();R.removeViewportFromToolGroup(w,t),O.removeViewportFromSyncGroup(w,t,n),U.clear(w)}),[w]),Z=(0,r.useCallback)((e=>{if(e.detail.element!==C.current)return;const{viewportId:t,element:n}=e.detail,r=k.getViewportInfo(t);(0,u.Yc)(t,n),b(n);const i=r.getRenderingEngineId(),a=r.getToolGroupId(),o=r.getSyncGroups();R.addViewportToToolGroup(t,i,a),O.addViewportToSyncGroup(t,i,o);const s=_.getState().synchronizersStore;s?.[t]?.length&&!E&&function(e,t,n){e[t].forEach((e=>{if(!e.id)return;const{id:r,sourceViewports:i,targetViewports:a}=e,o=n.getSynchronizer(r);if(!o)return;const s=i.find((e=>e.viewportId===t)),l=a.find((e=>e.viewportId===t)),c=o.getSourceViewports().find((e=>e.viewportId===t)),m=o.getTargetViewports().find((e=>e.viewportId===t));s&&!c&&o.addSource({viewportId:s.viewportId,renderingEngineId:s.renderingEngineId}),l&&!m&&o.addTarget({viewportId:l.viewportId,renderingEngineId:l.renderingEngineId})}))}(s,t,O),d&&d(e)}),[w,d,R]);(0,r.useEffect)((()=>(k.enableViewport(w,C.current),l.eventTarget.addEventListener(l.Enums.Events.ELEMENT_ENABLED,Z),W(),()=>{const e=k.getViewportInfo(w);e&&(k.storePresentation({viewportId:w}),H(e),g&&g(e),k.disableElement(w),l.eventTarget.removeEventListener(l.Enums.Events.ELEMENT_ENABLED,Z))})),[]),(0,r.useEffect)((()=>{const{unsubscribe:e}=D.subscribe(D.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,(async({displaySetInstanceUID:e,invalidateData:t})=>{if(!t)return;const r=k.getViewportInfo(w);if(r.hasDisplaySet(e)){const t=r.getViewportData(),i=await L.invalidateViewportData(t,e,n,D),a=!0;k.updateViewport(w,i,a)}}));return()=>{e()}}),[w]),(0,r.useEffect)((()=>{a.viewportType||(a.viewportType="stack");(async()=>{const e=await L.createViewportData(t,a,n,f),r=_.getState(),i=r.lutPresentationStore,l=r.positionPresentationStore,{presentationIds:c}=a,m={positionPresentation:l[c?.positionPresentationId],lutPresentation:i[c?.lutPresentationId]};let u;z?.viewportId===w&&(u=z.measurement,m.positionPresentation=null,z=null),a.needsRerendering&&(a.needsRerendering=!1),k.setViewportData(w,e,a,o,m),u&&s.annotation.selection.setAnnotationSelected(u.uid)})()}),[a,t,n]),(0,r.useEffect)((()=>{if(v)return;const e=function(e,t,n,r,i,a,o){const{unsubscribe:s}=e.subscribe(c.MeasurementService.EVENTS.JUMP_TO_MEASUREMENT_VIEWPORT,(i=>{z=i;const{viewportId:s,measurement:l,isConsumed:c}=i;l&&!c&&(void 0===z.cornerstoneViewport&&(z.cornerstoneViewport=o.getViewportIdToJump(s,l.displaySetInstanceUID,{referencedImageId:l.referencedImageId||l.metadata?.referencedImageId})),z.cornerstoneViewport===r&&K(l,n,r,e,t,a,o))}));return s}(V,D,C,w,0,A,k);return function(e,t,n,r,i,a,o){if(!z)return;if(z.isConsumed)return void(z=null);const s=i.map((e=>e.displaySetInstanceUID));if(!s?.length)return;const{measurement:l}=z;l&&n&&s.includes(l?.displaySetInstanceUID)&&K(l,n,r,e,t,a,o)}(V,D,C,w,t,A,k),()=>{e()}}),[t,C,w]),(0,r.useEffect)((()=>{if(!1===x.addWindowLevelActionMenu)return;const e=function({viewportId:e,element:t,displaySets:n,servicesManager:i,commandsManager:a,verticalDirection:o,horizontalDirection:s}){const{customizationService:l}=i.services,{presets:c}=l.get("cornerstone.windowLevelPresets"),m=l.get("cornerstone.colorbar"),{volumeRenderingPresets:u,volumeRenderingQualityRange:p}=l.get("cornerstone.3dVolumeRendering"),d=n.filter((e=>c[e.Modality])).map((e=>({[e.Modality]:c[e.Modality]})));return r.createElement(F,{viewportId:e,element:t,presets:d,verticalDirection:o,horizontalDirection:s,commandsManager:a,servicesManager:i,colorbarProperties:m,displaySets:n,volumeRenderingPresets:u,volumeRenderingQualityRange:p})}({viewportId:w,element:C.current,displaySets:t,servicesManager:p,commandsManager,verticalDirection:m.yZ.HO.TopToBottom,horizontalDirection:m.yZ.po.RightToLeft});U.setComponent({viewportId:w,id:"windowLevelActionMenu",component:e,location:U.LOCATIONS.topRight,indexPriority:-100})}),[t,w,U,p,commandsManager]);const{ref:q}=(0,i.N)({onResize:j});return r.createElement(r.Fragment,null,r.createElement("div",{className:"viewport-wrapper"},r.createElement("div",{className:"cornerstone-viewport-element",style:{height:"100%",width:"100%"},onContextMenu:e=>e.preventDefault(),onMouseDown:e=>e.preventDefault(),ref:e=>{q.current=e,C.current=e}}),r.createElement(h,{viewportId:w,toolBarService:N,element:C.current,scrollbarHeight:I,servicesManager:p}),r.createElement(T,{enabledVPElement:S,viewportId:w,servicesManager:p})),r.createElement("div",{className:"absolute top-[24px] w-full"},G.viewportId===w&&r.createElement(m.P_,{id:"viewport-notification",message:G.message,type:G.type,actions:G.actions,onSubmit:G.onSubmit,onOutsideClick:G.onOutsideClick,onKeyPress:G.onKeyPress})),r.createElement(P,{viewportId:w}))}),Z);function K(e,t,n,r,i,a,o){const c=t.current,{displaySetInstanceUID:m,SOPInstanceUID:u,frameNumber:p}=e;if(!u)return void console.warn("cannot jump in a non-acquisition plane measurements yet");const d=i.getDisplaySetByUID(m);a.setActiveViewportId(n);const g=(0,l.getEnabledElement)(c);if(g){const t=g.viewport;let n=0,r=!0;if(t instanceof l.StackViewport){n=t.getImageIds().findIndex((e=>{const{SOPInstanceUID:t,frameNumber:n}=(0,C.Z)(e);return t===u&&(!p||p===n)}))}else{const{viewPlaneNormal:i}=e.metadata;n=d.images.findIndex((e=>e.SOPInstanceUID===u));const{viewPlaneNormal:a}=t.getCamera();i&&!l.utilities.isEqual(i.map(Math.abs),a.map(Math.abs))&&(r=!1)}if(!r||-1===n)return;s.utilities.jumpToSlice(c,{imageIndex:n}),s.annotation.selection.setAnnotationSelected(e.uid),z?.consume?.(),z=null}}q.displayName="OHIFCornerstoneViewport",q.propTypes={displaySets:o().array.isRequired,dataSource:o().object.isRequired,viewportOptions:o().object,displaySetOptions:o().arrayOf(o().any),servicesManager:o().object.isRequired,onElementEnabled:o().func,isJumpToMeasurementDisabled:o().bool,initialImageIdOrIndex:o().oneOfType([o().string,o().number])};const $=q}}]);
//# sourceMappingURL=1169.bundle.6fd130c183b1e6be7d07.js.map