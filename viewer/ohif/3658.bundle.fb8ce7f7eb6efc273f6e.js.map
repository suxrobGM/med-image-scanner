{"version":3,"file":"3658.bundle.fb8ce7f7eb6efc273f6e.js","mappings":"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","sources":["webpack:///../../../extensions/cornerstone-dicom-rt/src/utils/promptHydrateRT.ts","webpack:///../../../extensions/cornerstone-dicom-rt/src/viewports/_getStatusComponent.tsx","webpack:///../../../extensions/cornerstone-dicom-rt/src/utils/initRTToolGroup.ts","webpack:///../../../extensions/cornerstone-dicom-rt/src/viewports/OHIFCornerstoneRTViewport.tsx"],"sourcesContent":["import { ButtonEnums } from '@ohif/ui';\r\n\r\nconst RESPONSE = {\r\n  NO_NEVER: -1,\r\n  CANCEL: 0,\r\n  HYDRATE_SEG: 5,\r\n};\r\n\r\nfunction promptHydrateRT({\r\n  servicesManager,\r\n  rtDisplaySet,\r\n  viewportId,\r\n  toolGroupId = 'default',\r\n  preHydrateCallbacks,\r\n  hydrateRTDisplaySet,\r\n}: withAppTypes) {\r\n  const { uiViewportDialogService } = servicesManager.services;\r\n  const extensionManager = servicesManager._extensionManager;\r\n  const appConfig = extensionManager._appConfig;\r\n  return new Promise(async function (resolve, reject) {\r\n    const promptResult = appConfig?.disableConfirmationPrompts\r\n      ? RESPONSE.HYDRATE_SEG\r\n      : await _askHydrate(uiViewportDialogService, viewportId);\r\n\r\n    if (promptResult === RESPONSE.HYDRATE_SEG) {\r\n      preHydrateCallbacks?.forEach(callback => {\r\n        callback();\r\n      });\r\n\r\n      window.setTimeout(async () => {\r\n        const isHydrated = await hydrateRTDisplaySet({\r\n          rtDisplaySet,\r\n          viewportId,\r\n          toolGroupId,\r\n          servicesManager,\r\n        });\r\n\r\n        resolve(isHydrated);\r\n      }, 0);\r\n    }\r\n  });\r\n}\r\n\r\nfunction _askHydrate(uiViewportDialogService: AppTypes.UIViewportDialogService, viewportId) {\r\n  return new Promise(function (resolve, reject) {\r\n    const message = 'Do you want to open this Segmentation?';\r\n    const actions = [\r\n      {\r\n        id: 'no-hydrate',\r\n        type: ButtonEnums.type.secondary,\r\n        text: 'No',\r\n        value: RESPONSE.CANCEL,\r\n      },\r\n      {\r\n        id: 'yes-hydrate',\r\n        type: ButtonEnums.type.primary,\r\n        text: 'Yes',\r\n        value: RESPONSE.HYDRATE_SEG,\r\n      },\r\n    ];\r\n    const onSubmit = result => {\r\n      uiViewportDialogService.hide();\r\n      resolve(result);\r\n    };\r\n\r\n    uiViewportDialogService.show({\r\n      id: 'promptHydrateRT',\r\n      viewportId,\r\n      type: 'info',\r\n      message,\r\n      actions,\r\n      onSubmit,\r\n      onOutsideClick: () => {\r\n        uiViewportDialogService.hide();\r\n        resolve(RESPONSE.CANCEL);\r\n      },\r\n      onKeyPress: event => {\r\n        if (event.key === 'Enter') {\r\n          onSubmit(RESPONSE.HYDRATE_SEG);\r\n        }\r\n      },\r\n    });\r\n  });\r\n}\r\n\r\nexport default promptHydrateRT;\r\n","import React from 'react';\r\nimport { useTranslation } from 'react-i18next';\r\nimport { Icon, Tooltip } from '@ohif/ui';\r\n\r\nexport default function _getStatusComponent({ isHydrated, onStatusClick }) {\r\n  let ToolTipMessage = null;\r\n  let StatusIcon = null;\r\n\r\n  switch (isHydrated) {\r\n    case true:\r\n      StatusIcon = () => <Icon name=\"status-alert\" />;\r\n\r\n      ToolTipMessage = () => <div>This Segmentation is loaded in the segmentation panel</div>;\r\n      break;\r\n    case false:\r\n      StatusIcon = () => (\r\n        <Icon\r\n          className=\"text-aqua-pale\"\r\n          name=\"status-untracked\"\r\n        />\r\n      );\r\n\r\n      ToolTipMessage = () => <div>Click LOAD to load RTSTRUCT.</div>;\r\n  }\r\n\r\n  const StatusArea = () => {\r\n    const { t } = useTranslation('Common');\r\n    const loadStr = t('LOAD');\r\n\r\n    return (\r\n      <div className=\"flex h-6 cursor-default text-sm leading-6 text-white\">\r\n        <div className=\"bg-customgray-100 flex min-w-[45px] items-center rounded-l-xl rounded-r p-1\">\r\n          <StatusIcon />\r\n          <span className=\"ml-1\">RTSTRUCT</span>\r\n        </div>\r\n        {!isHydrated && (\r\n          <div\r\n            className=\"bg-primary-main hover:bg-primary-light ml-1 cursor-pointer rounded px-1.5 hover:text-black\"\r\n            // Using onMouseUp here because onClick is not working when the viewport is not active and is styled with pointer-events:none\r\n            onMouseUp={onStatusClick}\r\n          >\r\n            {loadStr}\r\n          </div>\r\n        )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <>\r\n      {ToolTipMessage && (\r\n        <Tooltip\r\n          content={<ToolTipMessage />}\r\n          position=\"bottom-left\"\r\n        >\r\n          <StatusArea />\r\n        </Tooltip>\r\n      )}\r\n      {!ToolTipMessage && <StatusArea />}\r\n    </>\r\n  );\r\n}\r\n","function createRTToolGroupAndAddTools(ToolGroupService, customizationService, toolGroupId) {\r\n  const { tools } = customizationService.get('cornerstone.overlayViewportTools') ?? {};\r\n\r\n  return ToolGroupService.createToolGroupAndAddTools(toolGroupId, tools);\r\n}\r\n\r\nexport default createRTToolGroupAndAddTools;\r\n","import React, { useCallback, useEffect, useRef, useState } from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport { useViewportGrid, LoadingIndicatorTotalPercent, ViewportActionArrows } from '@ohif/ui';\r\n\r\nimport promptHydrateRT from '../utils/promptHydrateRT';\r\nimport _getStatusComponent from './_getStatusComponent';\r\nimport createRTToolGroupAndAddTools from '../utils/initRTToolGroup';\r\n\r\nconst RT_TOOLGROUP_BASE_NAME = 'RTToolGroup';\r\n\r\nfunction OHIFCornerstoneRTViewport(props: withAppTypes) {\r\n  const {\r\n    children,\r\n    displaySets,\r\n    viewportOptions,\r\n    servicesManager,\r\n    extensionManager,\r\n    commandsManager,\r\n  } = props;\r\n\r\n  const {\r\n    displaySetService,\r\n    toolGroupService,\r\n    segmentationService,\r\n    uiNotificationService,\r\n    customizationService,\r\n    viewportActionCornersService,\r\n  } = servicesManager.services;\r\n\r\n  const viewportId = viewportOptions.viewportId;\r\n\r\n  const toolGroupId = `${RT_TOOLGROUP_BASE_NAME}-${viewportId}`;\r\n\r\n  // RT viewport will always have a single display set\r\n  if (displaySets.length > 1) {\r\n    throw new Error('RT viewport should only have a single display set');\r\n  }\r\n\r\n  const rtDisplaySet = displaySets[0];\r\n\r\n  const [viewportGrid, viewportGridService] = useViewportGrid();\r\n\r\n  // States\r\n  const [isToolGroupCreated, setToolGroupCreated] = useState(false);\r\n  const [selectedSegment, setSelectedSegment] = useState(1);\r\n\r\n  // Hydration means that the RT is opened and segments are loaded into the\r\n  // segmentation panel, and RT is also rendered on any viewport that is in the\r\n  // same frameOfReferenceUID as the referencedSeriesUID of the RT. However,\r\n  // loading basically means RT loading over network and bit unpacking of the\r\n  // RT data.\r\n  const [isHydrated, setIsHydrated] = useState(rtDisplaySet.isHydrated);\r\n  const [rtIsLoading, setRtIsLoading] = useState(!rtDisplaySet.isLoaded);\r\n  const [element, setElement] = useState(null);\r\n  const [processingProgress, setProcessingProgress] = useState({\r\n    percentComplete: null,\r\n    totalSegments: null,\r\n  });\r\n\r\n  // refs\r\n  const referencedDisplaySetRef = useRef(null);\r\n\r\n  const { viewports, activeViewportId } = viewportGrid;\r\n\r\n  const referencedDisplaySet = rtDisplaySet.getReferenceDisplaySet();\r\n  const referencedDisplaySetMetadata = _getReferencedDisplaySetMetadata(referencedDisplaySet);\r\n\r\n  referencedDisplaySetRef.current = {\r\n    displaySet: referencedDisplaySet,\r\n    metadata: referencedDisplaySetMetadata,\r\n  };\r\n  /**\r\n   * OnElementEnabled callback which is called after the cornerstoneExtension\r\n   * has enabled the element. Note: we delegate all the image rendering to\r\n   * cornerstoneExtension, so we don't need to do anything here regarding\r\n   * the image rendering, element enabling etc.\r\n   */\r\n  const onElementEnabled = evt => {\r\n    setElement(evt.detail.element);\r\n  };\r\n\r\n  const onElementDisabled = () => {\r\n    setElement(null);\r\n  };\r\n\r\n  const storePresentationState = useCallback(() => {\r\n    viewportGrid?.viewports.forEach(({ viewportId }) => {\r\n      commandsManager.runCommand('storePresentation', {\r\n        viewportId,\r\n      });\r\n    });\r\n  }, [viewportGrid]);\r\n\r\n  const hydrateRTDisplaySet = ({ rtDisplaySet, viewportId }) => {\r\n    commandsManager.runCommand('loadSegmentationDisplaySetsForViewport', {\r\n      displaySets: [rtDisplaySet],\r\n      viewportId,\r\n    });\r\n  };\r\n\r\n  const getCornerstoneViewport = useCallback(() => {\r\n    const { component: Component } = extensionManager.getModuleEntry(\r\n      '@ohif/extension-cornerstone.viewportModule.cornerstone'\r\n    );\r\n\r\n    const { displaySet: referencedDisplaySet } = referencedDisplaySetRef.current;\r\n\r\n    // Todo: jump to the center of the first segment\r\n    return (\r\n      <Component\r\n        {...props}\r\n        displaySets={[referencedDisplaySet, rtDisplaySet]}\r\n        viewportOptions={{\r\n          viewportType: 'stack',\r\n          toolGroupId: toolGroupId,\r\n          orientation: viewportOptions.orientation,\r\n          viewportId: viewportOptions.viewportId,\r\n        }}\r\n        onElementEnabled={evt => {\r\n          props.onElementEnabled?.(evt);\r\n          onElementEnabled(evt);\r\n        }}\r\n        onElementDisabled={onElementDisabled}\r\n      ></Component>\r\n    );\r\n  }, [viewportId, rtDisplaySet, toolGroupId]);\r\n\r\n  const onSegmentChange = useCallback(\r\n    direction => {\r\n      const segmentationId = rtDisplaySet.displaySetInstanceUID;\r\n      const segmentation = segmentationService.getSegmentation(segmentationId);\r\n\r\n      const { segments } = segmentation;\r\n\r\n      const numberOfSegments = Object.keys(segments).length;\r\n\r\n      let newSelectedSegmentIndex = selectedSegment + direction;\r\n\r\n      // Segment 0 is always background\r\n      if (newSelectedSegmentIndex >= numberOfSegments - 1) {\r\n        newSelectedSegmentIndex = 1;\r\n      } else if (newSelectedSegmentIndex === 0) {\r\n        newSelectedSegmentIndex = numberOfSegments - 1;\r\n      }\r\n\r\n      segmentationService.jumpToSegmentCenter(segmentationId, newSelectedSegmentIndex, toolGroupId);\r\n      setSelectedSegment(newSelectedSegmentIndex);\r\n    },\r\n    [selectedSegment]\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (rtIsLoading) {\r\n      return;\r\n    }\r\n\r\n    promptHydrateRT({\r\n      servicesManager,\r\n      viewportId,\r\n      rtDisplaySet,\r\n      preHydrateCallbacks: [storePresentationState],\r\n      hydrateRTDisplaySet,\r\n    }).then(isHydrated => {\r\n      if (isHydrated) {\r\n        setIsHydrated(true);\r\n      }\r\n    });\r\n  }, [servicesManager, viewportId, rtDisplaySet, rtIsLoading]);\r\n\r\n  useEffect(() => {\r\n    // I'm not sure what is this, since in RT we support Overlapping segments\r\n    // via contours\r\n    const { unsubscribe } = segmentationService.subscribe(\r\n      segmentationService.EVENTS.SEGMENTATION_LOADING_COMPLETE,\r\n      evt => {\r\n        if (evt.rtDisplaySet.displaySetInstanceUID === rtDisplaySet.displaySetInstanceUID) {\r\n          setRtIsLoading(false);\r\n        }\r\n\r\n        if (evt.overlappingSegments) {\r\n          uiNotificationService.show({\r\n            title: 'Overlapping Segments',\r\n            message: 'Overlapping segments detected which is not currently supported',\r\n            type: 'warning',\r\n          });\r\n        }\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [rtDisplaySet]);\r\n\r\n  useEffect(() => {\r\n    const { unsubscribe } = segmentationService.subscribe(\r\n      segmentationService.EVENTS.SEGMENT_LOADING_COMPLETE,\r\n      ({ percentComplete, numSegments }) => {\r\n        setProcessingProgress({\r\n          percentComplete,\r\n          totalSegments: numSegments,\r\n        });\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      unsubscribe();\r\n    };\r\n  }, [rtDisplaySet]);\r\n\r\n  /**\r\n   Cleanup the SEG viewport when the viewport is destroyed\r\n   */\r\n  useEffect(() => {\r\n    const onDisplaySetsRemovedSubscription = displaySetService.subscribe(\r\n      displaySetService.EVENTS.DISPLAY_SETS_REMOVED,\r\n      ({ displaySetInstanceUIDs }) => {\r\n        const activeViewport = viewports.get(activeViewportId);\r\n        if (displaySetInstanceUIDs.includes(activeViewport.displaySetInstanceUID)) {\r\n          viewportGridService.setDisplaySetsForViewport({\r\n            viewportId: activeViewportId,\r\n            displaySetInstanceUIDs: [],\r\n          });\r\n        }\r\n      }\r\n    );\r\n\r\n    return () => {\r\n      onDisplaySetsRemovedSubscription.unsubscribe();\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    let toolGroup = toolGroupService.getToolGroup(toolGroupId);\r\n\r\n    if (toolGroup) {\r\n      return;\r\n    }\r\n\r\n    toolGroup = createRTToolGroupAndAddTools(toolGroupService, customizationService, toolGroupId);\r\n\r\n    setToolGroupCreated(true);\r\n\r\n    return () => {\r\n      // remove the segmentation representations if seg displayset changed\r\n      segmentationService.removeSegmentationRepresentationFromToolGroup(toolGroupId);\r\n\r\n      toolGroupService.destroyToolGroup(toolGroupId);\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    setIsHydrated(rtDisplaySet.isHydrated);\r\n\r\n    return () => {\r\n      // remove the segmentation representations if seg displayset changed\r\n      segmentationService.removeSegmentationRepresentationFromToolGroup(toolGroupId);\r\n      referencedDisplaySetRef.current = null;\r\n    };\r\n  }, [rtDisplaySet]);\r\n\r\n  // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n  let childrenWithProps = null;\r\n\r\n  if (\r\n    !referencedDisplaySetRef.current ||\r\n    referencedDisplaySet.displaySetInstanceUID !==\r\n      referencedDisplaySetRef.current.displaySet.displaySetInstanceUID\r\n  ) {\r\n    return null;\r\n  }\r\n\r\n  if (children && children.length) {\r\n    childrenWithProps = children.map((child, index) => {\r\n      return (\r\n        child &&\r\n        React.cloneElement(child, {\r\n          viewportId,\r\n          key: index,\r\n        })\r\n      );\r\n    });\r\n  }\r\n\r\n  const onStatusClick = useCallback(async () => {\r\n    // Before hydrating a RT and make it added to all viewports in the grid\r\n    // that share the same frameOfReferenceUID, we need to store the viewport grid\r\n    // presentation state, so that we can restore it after hydrating the RT. This is\r\n    // required if the user has changed the viewport (other viewport than RT viewport)\r\n    // presentation state (w/l and invert) and then opens the RT. If we don't store\r\n    // the presentation state, the viewport will be reset to the default presentation\r\n    storePresentationState();\r\n    const isHydrated = await hydrateRTDisplaySet({\r\n      rtDisplaySet,\r\n      viewportId,\r\n    });\r\n\r\n    setIsHydrated(isHydrated);\r\n  }, [hydrateRTDisplaySet, rtDisplaySet, storePresentationState, viewportId]);\r\n\r\n  useEffect(() => {\r\n    viewportActionCornersService.setComponents([\r\n      {\r\n        viewportId,\r\n        id: 'viewportStatusComponent',\r\n        component: _getStatusComponent({\r\n          isHydrated,\r\n          onStatusClick,\r\n        }),\r\n        indexPriority: -100,\r\n        location: viewportActionCornersService.LOCATIONS.topLeft,\r\n      },\r\n      {\r\n        viewportId,\r\n        id: 'viewportActionArrowsComponent',\r\n        component: (\r\n          <ViewportActionArrows\r\n            key=\"actionArrows\"\r\n            onArrowsClick={onSegmentChange}\r\n            className={\r\n              viewportId === activeViewportId ? 'visible' : 'invisible group-hover:visible'\r\n            }\r\n          ></ViewportActionArrows>\r\n        ),\r\n        indexPriority: 0,\r\n        location: viewportActionCornersService.LOCATIONS.topRight,\r\n      },\r\n    ]);\r\n  }, [\r\n    activeViewportId,\r\n    isHydrated,\r\n    onSegmentChange,\r\n    onStatusClick,\r\n    viewportActionCornersService,\r\n    viewportId,\r\n  ]);\r\n\r\n  return (\r\n    <>\r\n      <div className=\"relative flex h-full w-full flex-row overflow-hidden\">\r\n        {rtIsLoading && (\r\n          <LoadingIndicatorTotalPercent\r\n            className=\"h-full w-full\"\r\n            totalNumbers={processingProgress.totalSegments}\r\n            percentComplete={processingProgress.percentComplete}\r\n            loadingText=\"Loading RTSTRUCT...\"\r\n          />\r\n        )}\r\n        {getCornerstoneViewport()}\r\n        {childrenWithProps}\r\n      </div>\r\n    </>\r\n  );\r\n}\r\n\r\nOHIFCornerstoneRTViewport.propTypes = {\r\n  displaySets: PropTypes.arrayOf(PropTypes.object),\r\n  viewportId: PropTypes.string.isRequired,\r\n  dataSource: PropTypes.object,\r\n  children: PropTypes.node,\r\n};\r\n\r\nfunction _getReferencedDisplaySetMetadata(referencedDisplaySet) {\r\n  const image0 = referencedDisplaySet.images[0];\r\n  const referencedDisplaySetMetadata = {\r\n    PatientID: image0.PatientID,\r\n    PatientName: image0.PatientName,\r\n    PatientSex: image0.PatientSex,\r\n    PatientAge: image0.PatientAge,\r\n    SliceThickness: image0.SliceThickness,\r\n    StudyDate: image0.StudyDate,\r\n    SeriesDescription: image0.SeriesDescription,\r\n    SeriesInstanceUID: image0.SeriesInstanceUID,\r\n    SeriesNumber: image0.SeriesNumber,\r\n    ManufacturerModelName: image0.ManufacturerModelName,\r\n    SpacingBetweenSlices: image0.SpacingBetweenSlices,\r\n  };\r\n\r\n  return referencedDisplaySetMetadata;\r\n}\r\n\r\nexport default OHIFCornerstoneRTViewport;\r\n"],"names":["RESPONSE","NO_NEVER","CANCEL","HYDRATE_SEG","servicesManager","rtDisplaySet","viewportId","toolGroupId","preHydrateCallbacks","hydrateRTDisplaySet","uiViewportDialogService","services","appConfig","_extensionManager","_appConfig","Promise","async","resolve","reject","promptResult","disableConfirmationPrompts","message","actions","id","type","ButtonEnums","secondary","text","value","primary","onSubmit","result","hide","show","onOutsideClick","onKeyPress","event","key","_askHydrate","forEach","callback","window","setTimeout","isHydrated","_getStatusComponent","onStatusClick","ToolTipMessage","StatusIcon","React","Icon","name","className","StatusArea","t","useTranslation","loadStr","onMouseUp","Tooltip","content","position","ToolGroupService","customizationService","tools","get","createToolGroupAndAddTools","OHIFCornerstoneRTViewport","props","children","displaySets","viewportOptions","extensionManager","commandsManager","displaySetService","toolGroupService","segmentationService","uiNotificationService","viewportActionCornersService","length","Error","viewportGrid","viewportGridService","useViewportGrid","isToolGroupCreated","setToolGroupCreated","useState","selectedSegment","setSelectedSegment","setIsHydrated","rtIsLoading","setRtIsLoading","isLoaded","element","setElement","processingProgress","setProcessingProgress","percentComplete","totalSegments","referencedDisplaySetRef","useRef","viewports","activeViewportId","referencedDisplaySet","getReferenceDisplaySet","referencedDisplaySetMetadata","image0","images","PatientID","PatientName","PatientSex","PatientAge","SliceThickness","StudyDate","SeriesDescription","SeriesInstanceUID","SeriesNumber","ManufacturerModelName","SpacingBetweenSlices","_getReferencedDisplaySetMetadata","current","displaySet","metadata","onElementDisabled","storePresentationState","useCallback","runCommand","getCornerstoneViewport","component","Component","getModuleEntry","_extends","viewportType","orientation","onElementEnabled","evt","detail","onSegmentChange","direction","segmentationId","displaySetInstanceUID","segmentation","getSegmentation","segments","numberOfSegments","Object","keys","newSelectedSegmentIndex","jumpToSegmentCenter","useEffect","promptHydrateRT","then","unsubscribe","subscribe","EVENTS","SEGMENTATION_LOADING_COMPLETE","overlappingSegments","title","SEGMENT_LOADING_COMPLETE","numSegments","onDisplaySetsRemovedSubscription","DISPLAY_SETS_REMOVED","displaySetInstanceUIDs","activeViewport","includes","setDisplaySetsForViewport","toolGroup","getToolGroup","createRTToolGroupAndAddTools","removeSegmentationRepresentationFromToolGroup","destroyToolGroup","childrenWithProps","map","child","index","setComponents","indexPriority","location","LOCATIONS","topLeft","ViewportActionArrows","onArrowsClick","topRight","LoadingIndicatorTotalPercent","totalNumbers","loadingText","propTypes","PropTypes","isRequired","dataSource"],"sourceRoot":""}