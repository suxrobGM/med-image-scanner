"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[7360],{91851:(e,n,t)=>{t.d(n,{Z:()=>r});var a=t(91202);const{CodeScheme:o}=a.adaptersSR.Cornerstone3D,r={ImagingMeasurementReport:"126000",ImageLibrary:"111028",ImagingMeasurements:"126010",MeasurementGroup:"125007",ImageLibraryGroup:"126200",TrackingUniqueIdentifier:"112040",TrackingIdentifier:"112039",Finding:"121071",FindingSite:"G-C0E3",CornerstoneFreeText:o.codeValues.CORNERSTONEFREETEXT}},97360:(e,n,t)=>{t.r(n),t.d(n,{createReferencedImageDisplaySet:()=>J.Z,default:()=>ne,hydrateStructuredReport:()=>X.Z,srProtocol:()=>G});var a=t(43001);const o=JSON.parse('{"u2":"@ohif/extension-cornerstone-dicom-sr"}').u2,r="dicom-sr",s=`${o}.sopClassHandlerModule.${r}`;var i=t(84793),c=t(72076),l=t(93725),d=t(12651),u=t(75449);const S={POINT:"POINT",MULTIPOINT:"MULTIPOINT",POLYLINE:"POLYLINE",CIRCLE:"CIRCLE",ELLIPSE:"ELLIPSE"};class g extends l.AnnotationTool{constructor(e={},n={configuration:{}}){super(e,n),this.isPointNearTool=()=>null,this.getHandleNearImagePoint=()=>null,this.renderAnnotation=(e,n)=>{const{viewport:t}=e,{element:a}=t;let o=l.annotation.state.getAnnotations(this.getToolName(),a);if(!o?.length)return;if(o=this.filterInteractableAnnotationsForElement(a,o),!o?.length)return;const r=(0,u.yR)(a),{activeIndex:s,trackingUniqueIdentifiers:i}=r,c=i[s],d=o.filter((e=>i.includes(e.data?.TrackingUniqueIdentifier)));if(!t._actors?.size)return;const g={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},{style:f}=l.annotation.config;for(let e=0;e<d.length;e++){const a=d[e],o=a.annotationUID,{renderableData:r,TrackingUniqueIdentifier:s}=a.data,{referencedImageId:i}=a.metadata;g.annotationUID=o;const u=f.getToolGroupToolStyles(this.toolGroupId)[this.getToolName()],I=this.getStyle("lineWidth",g,a),m=this.getStyle("lineDash",g,a),p={color:s===c?"rgb(0, 255, 0)":this.getStyle("color",g,a),lineDash:m,lineWidth:I,...u};Object.keys(r).forEach((e=>{const s=r[e];let c,d;switch(e){case S.POINT:c=this.renderPoint;break;case S.MULTIPOINT:c=this.renderMultipoint;break;case S.POLYLINE:c=this.renderPolyLine;break;case S.CIRCLE:c=this.renderEllipse;break;case S.ELLIPSE:c=this.renderEllipse,d=l.utilities.math.ellipse.getCanvasEllipseCorners;break;default:throw new Error(`Unsupported GraphicType: ${e}`)}const u=c(n,t,s,o,i,p);this.renderTextBox(n,t,u,d,a,g,p)}))}}}_getTextBoxLinesFromLabels(e){const n=Math.min(e.length,5),t=[];for(let a=0;a<n;a++){const n=e[a];t.push(`${I(n.label)}: ${n.value}`)}return t}renderPolyLine(e,n,t,a,o,r){const s={color:r.color,width:r.lineWidth,lineDash:r.lineDash};let i=[];return t.map(((t,o)=>{const r=t.map((e=>n.worldToCanvas(e))),c=`${o}`;2===r.length?l.drawing.drawLine(e,a,c,r[0],r[1],s):l.drawing.drawPolyline(e,a,c,r,s),i=i.concat(r)})),i}renderMultipoint(e,n,t,a,o,r){let s;t.map(((t,o)=>{s=t.map((e=>n.worldToCanvas(e)));l.drawing.drawHandles(e,a,"0",s,{color:r.color})}))}renderPoint(e,n,t,a,o,r){const s=[];return t.map(((t,i)=>{const c=t[0];s.push(n.worldToCanvas(c));const u=d.metaData.get("imagePixelModule",o);let S=10,g=10;if(u){const{columns:e,rows:n}=u;S=e/10,g=n/10}const f=d.utilities.worldToImageCoords(o,c),I=d.utilities.imageToWorldCoords(o,[f[0]+S,f[1]+g]);s.push(n.worldToCanvas(I));const m=`${i}`;l.drawing.drawArrow(e,a,m,s[1],s[0],{color:r.color,width:r.lineWidth})})),s}renderEllipse(e,n,t,a,o,r){let s;return t.map(((t,o)=>{if(0===t.length)return;const i=t,c=n.getRotation();let d;s=i.map((e=>n.worldToCanvas(e))),d=90==c||270==c?l.utilities.math.ellipse.getCanvasEllipseCorners([s[2],s[3],s[0],s[1]]):l.utilities.math.ellipse.getCanvasEllipseCorners(s);const u=`${o}`;l.drawing.drawEllipse(e,a,u,d[0],d[1],{color:r.color,width:r.lineWidth,lineDash:r.lineDash})})),s}renderTextBox(e,n,t,a,o,r,s={}){if(!t||!o)return;const{annotationUID:i,data:c={}}=o,{label:d}=c,{color:u}=s;let S=t;"function"==typeof a&&(S=a(t));const g=this._getTextBoxLinesFromLabels(d),f=l.utilities.drawing.getTextBoxCoordsCanvas(S);o.data?.handles?.textBox?.worldPosition||(o.data.handles.textBox.worldPosition=n.canvasToWorld(f));const I=n.worldToCanvas(o.data.handles.textBox.worldPosition),m=this.getLinkedTextBoxStyle(r,o),p=l.drawing.drawLinkedTextBox(e,i,"1",g,I,t,{},{...m,color:u}),{x:R,y:h,width:C,height:T}=p;o.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([R,h]),topRight:n.canvasToWorld([R+C,h]),bottomLeft:n.canvasToWorld([R,h+T]),bottomRight:n.canvasToWorld([R+C,h+T])}}}g.toolName="DICOMSRDisplay";const f={"Short Axis":"W: ","Long Axis":"L: ",AREA:"Area: ",Length:"",CORNERSTONEFREETEXT:""};function I(e){const n=f[e];return void 0!==n?n:e}const m={DICOMSRDisplay:g.toolName,SRLength:"SRLength",SRBidirectional:"SRBidirectional",SREllipticalROI:"SREllipticalROI",SRCircleROI:"SRCircleROI",SRArrowAnnotate:"SRArrowAnnotate",SRAngle:"SRAngle",SRCobbAngle:"SRCobbAngle",SRRectangleROI:"SRRectangleROI",SRPlanarFreehandROI:"SRPlanarFreehandROI"},p=1e-4;function R(e,n,t){const a=m.DICOMSRDisplay,o={TrackingUniqueIdentifier:e.TrackingUniqueIdentifier,renderableData:{},labels:e.labels,imageId:n};e.coords.forEach((e=>{const{GraphicType:t,GraphicData:a}=e;void 0===o.renderableData[t]&&(o.renderableData[t]=[]),o.renderableData[t].push(function(e,n,t){let a;switch(e){case S.POINT:case S.MULTIPOINT:case S.POLYLINE:a=[];for(let e=0;e<n.length;e+=2){const o=d.utilities.imageToWorldCoords(t,[n[e],n[e+1]]);a.push(o)}break;case S.CIRCLE:{const e=[];for(let a=0;a<n.length;a+=2){const o=d.utilities.imageToWorldCoords(t,[n[a],n[a+1]]);e.push(o)}const o=e[0],r=e[1],s=c.R3.distance(o,r),i=d.metaData.get("imagePlaneModule",t);if(!i)throw new Error("No imagePlaneModule found");const{columnCosines:l,rowCosines:u}=i,S=c.R3.create();c.R3.scaleAndAdd(S,o,l,s);const g=c.R3.create();c.R3.scaleAndAdd(g,o,l,-s);const f=c.R3.create();c.R3.scaleAndAdd(f,o,u,s);const I=c.R3.create();c.R3.scaleAndAdd(I,o,u,-s),a=[S,g,f,I];break}case S.ELLIPSE:{const e=[];for(let a=0;a<n.length;a+=2){const o=d.utilities.imageToWorldCoords(t,[n[a],n[a+1]]);e.push(o)}const o=c.R3.fromValues(...e[0]),r=c.R3.fromValues(...e[1]),s=c.R3.fromValues(...e[2]),i=c.R3.fromValues(...e[3]),l=c.R3.create();c.R3.sub(l,r,o),c.R3.normalize(l,l);const u=c.R3.create();c.R3.sub(u,i,s),c.R3.normalize(u,u);const S=d.metaData.get("imagePlaneModule",t);if(!S)throw new Error("imageId does not have imagePlaneModule metadata");const{columnCosines:g}=S,f=c.R3.fromValues(...g),I=Math.abs(c.R3.dot(f,l)),m=Math.abs(c.R3.dot(f,u)),R=Math.abs(I),h=Math.abs(m);a=[],Math.abs(R-1)<p?a=[e[0],e[1],e[2],e[3]]:Math.abs(h-1)<p?a=[e[2],e[3],e[0],e[1]]:console.warn("OBLIQUE ELLIPSE NOT YET SUPPORTED");break}default:console.warn("Unsupported GraphicType:",e)}return a}(t,a,n))}));const r=d.metaData.get("imagePlaneModule",n),s={annotationUID:e.TrackingUniqueIdentifier,highlighted:!1,isLocked:!1,invalidated:!1,metadata:{toolName:a,FrameOfReferenceUID:r.frameOfReferenceUID,referencedImageId:n},data:{label:e.labels,handles:{textBox:e.textBox??{}},cachedStats:{},TrackingUniqueIdentifier:o.TrackingUniqueIdentifier,renderableData:o.renderableData,frameNumber:t}};l.annotation.state.getAnnotationManager().addAnnotation(s)}var h=t(91202);const C=h.adaptersSR.Cornerstone3D.MeasurementReport.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,T=["cornerstoneTools@^4.0.0"],D=C.CORNERSTONE_3D_TAG;var O=t(91851);const{CodeScheme:E}=h.adaptersSR.Cornerstone3D,{ImageSet:y,MetadataProvider:U}=i.classes,b=["1.2.840.10008.5.1.4.1.1.88.11","1.2.840.10008.5.1.4.1.1.88.22","1.2.840.10008.5.1.4.1.1.88.33","1.2.840.10008.5.1.4.1.1.88.34"],N="Cornerstone3DTools",w="0.1",M=(e,n)=>{n.forEach((n=>{if(n.StudyInstanceUID!==e)throw console.warn("Not all instances have the same UID",e,n),new Error(`Instances ${n.SOPInstanceUID} does not belong to ${e}`)}))},v={SRT:"SRT",CornerstoneCodeSchemes:[E.CodingSchemeDesignator,"CST4"]},P={INFERRED_FROM:"INFERRED FROM",CONTAINS:"CONTAINS"},A="CORNERSTONEFREETEXT";function q(e,n){return this.instances.push(...e),i.utils.sortStudyInstances(this.instances),this.instance=this.instances[this.instances.length-1],this.isLoaded=!1,this}function L(e,n,t){if(!e||!e.length)throw new Error("No instances were provided");i.utils.sortStudyInstances(e);const a=e[e.length-1],{StudyInstanceUID:o,SeriesInstanceUID:r,SOPInstanceUID:c,SeriesDescription:l,SeriesNumber:d,SeriesDate:u,ConceptNameCodeSequence:S,SOPClassUID:g}=a;M(a.StudyInstanceUID,e);const f=S?.CodeValue===O.Z.ImagingMeasurementReport,I={Modality:"SR",displaySetInstanceUID:i.utils.guid(),SeriesDescription:l,SeriesNumber:d,SeriesDate:u,SOPInstanceUID:c,SeriesInstanceUID:r,StudyInstanceUID:o,SOPClassHandlerId:s,SOPClassUID:g,instances:e,referencedImages:null,measurements:null,isDerivedDisplaySet:!0,isLoaded:!1,isImagingMeasurementReport:f,sopClassUids:b,instance:a,addInstances:q};return I.load=()=>async function(e,n,t){const{displaySetService:a,measurementService:o}=n.services,r=t.getDataSources(),s=r[0],{ContentSequence:i}=e.instance;async function c(n,t=null,a=null){for(const o in n)if("object"==typeof n[o]&&null!==n[o])await c(n[o],n,o);else if(Array.isArray(n[o]))await Promise.all(n[o].map((e=>c(e,n,o))));else if("BulkDataURI"===o){const r=await s.retrieve.bulkDataURI({BulkDataURI:n[o],StudyInstanceUID:e.instance.StudyInstanceUID,SeriesInstanceUID:e.instance.SeriesInstanceUID,SOPInstanceUID:e.instance.SOPInstanceUID});t&&a&&(t[a]=new Float32Array(r))}}!0!==e.isLoaded&&await c(i);e.isImagingMeasurementReport?(e.referencedImages=function(e){const n=e.find((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.ImageLibrary));if(!n)return[];const t=B(n.ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.ImageLibraryGroup)),a=[];return B(t.ContentSequence).forEach((e=>{const{ReferencedSOPSequence:n}=e;if(n)for(const e of B(n))if(e.ReferencedSOPClassUID){const{ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t}=e;a.push({ReferencedSOPClassUID:n,ReferencedSOPInstanceUID:t})}})),a}(i),e.measurements=function(e){const n=e.find((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.ImagingMeasurements));if(!n)return[];const t=function(e){const n={};return e.forEach((e=>{const t=B(e.ContentSequence),a=t.find((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.TrackingUniqueIdentifier));a||console.warn("No Tracking Unique Identifier, skipping ambiguous measurement.");const o=a.UID;void 0===n[o]?n[o]=[...t]:t.forEach((e=>{e.ConceptNameCodeSequence.CodeValue!==O.Z.TrackingUniqueIdentifier&&n[o].push(e)}))})),n}(B(n.ContentSequence).filter((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.MeasurementGroup))),a=[];return Object.keys(t).forEach((e=>{const n=function(e){if(e.some((e=>"SCOORD"===e.ValueType||"SCOORD3D"===e.ValueType)))return function(e){const n=e.find((e=>"SCOORD"===e.ValueType)),t=e.find((e=>"UIDREF"===e.ValueType)),a=e.find((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.TrackingIdentifier));if(!n)return void console.warn(`graphic ValueType ${n.ValueType} not currently supported, skipping annotation.`);const o=e.filter((e=>"NUM"===e.ValueType)),r={loaded:!1,labels:[],coords:[x(n)],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:a.TextValue};return o.forEach((e=>{const{ConceptNameCodeSequence:n,MeasuredValueSequence:t}=e;t&&r.labels.push(F(n,t))})),r}(e);return function(e){const n=e.filter((e=>"NUM"===e.ValueType)),t=e.find((e=>"UIDREF"===e.ValueType)),a=e.find((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.TrackingIdentifier)),o=e.find((e=>e.ConceptNameCodeSequence.CodeValue===O.Z.Finding)),r=e.filter((e=>e.ConceptNameCodeSequence.CodingSchemeDesignator===v.SRT&&e.ConceptNameCodeSequence.CodeValue===O.Z.FindingSite)),s={loaded:!1,labels:[],coords:[],TrackingUniqueIdentifier:t.UID,TrackingIdentifier:a.TextValue};o&&v.CornerstoneCodeSchemes.includes(o.ConceptCodeSequence.CodingSchemeDesignator)&&o.ConceptCodeSequence.CodeValue===O.Z.CornerstoneFreeText&&s.labels.push({label:A,value:o.ConceptCodeSequence.CodeMeaning});if(r.length){const e=r.find((e=>v.CornerstoneCodeSchemes.includes(e.ConceptCodeSequence.CodingSchemeDesignator)&&e.ConceptCodeSequence.CodeValue===O.Z.CornerstoneFreeText));e&&s.labels.push({label:A,value:e.ConceptCodeSequence.CodeMeaning})}return n.forEach((e=>{const{ConceptNameCodeSequence:n,ContentSequence:t,MeasuredValueSequence:a}=e,{ValueType:o}=t;if("SCOORD"===!o)return void console.warn(`Graphic ${o} not currently supported, skipping annotation.`);const r=x(t);r&&s.coords.push(r),a&&s.labels.push(F(n,a))})),s}(e)}(t[e]);n&&a.push(n)})),a}(i)):(e.referencedImages=[],e.measurements=[]);const l=o.getSourceMappings(N,w);e.isHydrated=!1,e.isRehydratable=function(e,n){if(!n||!n.length)return!1;const t=n.map((e=>e.annotationType)),{measurements:a}=e,o=Object.keys(C).filter((e=>"function"==typeof C[e].isValidCornerstoneTrackingIdentifier)),r=[];o.forEach((e=>{t.includes(e)&&r.push(C[e])}));for(let e=0;e<a.length;e++){const{TrackingIdentifier:n}=a[e]||{};if(r.some((e=>{let[t,a]=n.split(":");T.includes(t)&&(t=D);const o=`${t}:${a}`;return e.isValidCornerstoneTrackingIdentifier(o)})))return!0;console.log("Measurement is not rehydratable",n,a[e])}return console.log("No measurements found which were rehydratable"),!1}(e,l),e.isLoaded=!0,a.activeDisplaySets.forEach((t=>{k(e,t,s,n)})),a.subscribe(a.EVENTS.DISPLAY_SETS_ADDED,(t=>{const{displaySetsAdded:a}=t;a.forEach((t=>{k(e,t,s,n)}))}))}(I,n,t),[I]}function k(e,n,t,a){const{customizationService:o}=a.services;let r=e.measurements.filter((e=>!1===e.loaded));if(0===r.length)return;if(!n instanceof y)return;if(n.unsupported)return;const{sopClassUids:s}=n;if(r=r.filter((e=>e.coords.some((e=>s.includes(e.ReferencedSOPSequence.ReferencedSOPClassUID))))),0===r.length)return;const i=[];r.forEach((e=>{const{coords:n}=e;n.forEach((e=>{const n=e.ReferencedSOPSequence.ReferencedSOPInstanceUID;i.includes(n)||i.push(n)}))}));const c=t.getImageIdsForDisplaySet(n);for(const t of c){if(!r.length)return;const{SOPInstanceUID:a,frameNumber:s}=U.getUIDsFromImageID(t);if(i.includes(a))for(let i=r.length-1;i>=0;i--){let c=r[i];const l=o.getModeCustomization("onBeforeSRAddMeasurement")?.value;if("function"==typeof l&&(c=l({measurement:c,StudyInstanceUID:e.StudyInstanceUID,SeriesInstanceUID:e.SeriesInstanceUID})),V(c,a,s)){const e=c.coords[0].ReferencedSOPSequence&&c.coords[0].ReferencedSOPSequence?.ReferencedFrameNumber||1;R(c,t,e),c.loaded=!0,c.imageId=t,c.displaySetInstanceUID=n.displaySetInstanceUID,c.ReferencedSOPInstanceUID=c.coords[0].ReferencedSOPSequence.ReferencedSOPInstanceUID,c.frameNumber=e,delete c.coords,r.splice(i,1)}}}}function V(e,n,t){const{coords:a}=e,o=e.coords[0].ReferencedSOPSequence&&e.coords[0].ReferencedSOPSequence?.ReferencedFrameNumber||1;if(t&&Number(t)!==Number(o))return!1;for(let e=0;e<a.length;e++){const t=a[e],{ReferencedSOPInstanceUID:o}=t.ReferencedSOPSequence;if(o===n)return!0}}function x(e){const{ValueType:n,RelationshipType:t,GraphicType:a,GraphicData:o}=e;if(t!=P.INFERRED_FROM&&t!=P.CONTAINS)return void console.warn(`Relationshiptype === ${t}. Cannot deal with NON TID-1400 SCOORD group with RelationshipType !== "INFERRED FROM" or "CONTAINS"`);const r={ValueType:n,GraphicType:a,GraphicData:o};if("SCOORD"===n){const{ReferencedSOPSequence:n}=e.ContentSequence;r.ReferencedSOPSequence=n}else if("SCOORD3D"===n){const{ReferencedFrameOfReferenceSequence:n}=e.ContentSequence;r.ReferencedFrameOfReferenceSequence=n}return r}function F(e,n){const{CodeMeaning:t}=e,{NumericValue:a,MeasurementUnitsCodeSequence:o}=n,{CodeValue:r}=o;return{label:t,value:`${a?Number(a).toFixed(2):""} ${r}`}}function B(e){return e?Array.isArray(e)?e:[e]:[]}const $=function({servicesManager:e,extensionManager:n}){return[{name:r,sopClassUids:b,getDisplaySetsFromSeries:t=>L(t,e,n)}]},G={id:"@ohif/sr",name:"SR Key Images",protocolMatchingRules:[],toolGroupIds:["default"],numberOfPriorsReferenced:0,defaultViewport:{viewportOptions:{viewportType:"stack",toolGroupId:"default",allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId",matchedDisplaySetsIndex:-1}]},displaySetSelectors:{srDisplaySetId:{seriesMatchingRules:[{attribute:"Modality",constraint:{equals:"SR"}}]}},stages:[{name:"SR Key Images",viewportStructure:{layoutType:"grid",properties:{rows:1,columns:1}},viewports:[{viewportOptions:{allowUnmatchedView:!0},displaySets:[{id:"srDisplaySetId"}]}]}]};var _=t(67540);const{log:Z}=i.default;const W=function(e,n){const t={};function a(a,o){if(!a.metadata?.referencedImageId)return void Z.warn(`[DICOMSR] No referencedImageId found for ${o} ${a.id}`);const r=a.metadata.referencedImageId;t[r]||(t[r]={});const s=t[r];s[o]||(s[o]={data:[]});const i=e.find((e=>e.uid===a.annotationUID)),c=s[o].data;let{finding:l}=i;const d=[];i.label&&(n.includes(o)?l={CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:i.label}:d.push({CodeValue:"CORNERSTONEFREETEXT",CodingSchemeDesignator:"CORNERSTONEJS",CodeMeaning:i.label})),i.findingSites&&d.push(...i.findingSites);const u=Object.assign({},a,{finding:l,findingSites:d});c.push(u)}const o=e.map((e=>e.uid)).slice(),r=l.annotation.state.getAnnotationManager(),s=r.getFramesOfReference();for(let e=0;e<s.length;e++){const n=s[e],i=r.getAnnotations(n),c=Object.keys(i);for(let e=0;e<c.length;e++){const n=c[e],r=i[n];if(r)for(let e=0;e<r.length;e++){const s=r[e],i=o.findIndex((e=>e===s.annotationUID));if(-1!==i&&(a(s,n),o.splice(i,1),!o.length))return t}}}return t},{MeasurementReport:j}=h.adaptersSR.Cornerstone3D,{log:H}=i.default,z=e=>{const{servicesManager:n}=e,{customizationService:t}=n.services,a={downloadReport:({measurementData:e,additionalFindingTypes:n,options:t={}})=>{const o=a.generateReport(e,n,t),r=_.default.data.datasetToBlob(o),s=URL.createObjectURL(r);window.location.assign(s)},storeMeasurements:async({measurementData:e,dataSource:n,additionalFindingTypes:a,options:o={}})=>{if(H.info("[DICOMSR] storeMeasurements"),!n||!n.store||!n.store.dicom)return H.error("[DICOMSR] datasource has no dataSource.store.dicom endpoint!"),Promise.reject({});try{const r=((e,n,t={})=>{const a=W(e,n),o=j.generateReport(a,d.metaData,d.utilities.worldToImageCoords,t),{dataset:r}=o;return void 0===r.SpecificCharacterSet&&(r.SpecificCharacterSet="ISO_IR 192"),r})(e,a,o),{StudyInstanceUID:s,ContentSequence:c}=r;if(!c?.[4].ContentSequence?.length)throw console.log("naturalizedReport missing imaging content",r),new Error("Invalid report, no content");const l=t.getModeCustomization("onBeforeDicomStore")?.value;let u;return"function"==typeof l&&(u=l({measurementData:e,naturalizedReport:r})),await n.store.dicom(r,null,u),s&&n.deleteStudyMetadataPromise(s),i.DicomMetadataStore.addInstances([r],!0),r}catch(e){throw console.warn(e),H.error(`[DICOMSR] Error while saving the measurements: ${e.message}`),new Error(e.message||"Error while saving the measurements.")}}},o={downloadReport:{commandFn:a.downloadReport},storeMeasurements:{commandFn:a.storeMeasurements}};return{actions:a,definitions:o,defaultContext:"CORNERSTONE_STRUCTURED_REPORT"}};function Y(e,n,t){class a extends n{}a.toolName=e,(0,l.addTool)(a)}var X=t(83330),J=t(92522);function K(){return K=Object.assign?Object.assign.bind():function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var a in t)({}).hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},K.apply(null,arguments)}const Q=a.lazy((()=>t.e(8714).then(t.bind(t,78714)))),ee=e=>a.createElement(a.Suspense,{fallback:a.createElement("div",null,"Loading...")},a.createElement(Q,e)),ne={id:o,onModeEnter:function({servicesManager:e}){const{displaySetService:n}=e.services;[...n.getDisplaySetCache().values()].filter((e=>e.SOPClassHandlerId===s)).forEach((e=>{e.isHydrated=!1}))},preRegistration:function({configuration:e={}}){Y(m.DICOMSRDisplay,g),Y(m.SRLength,l.LengthTool),Y(m.SRBidirectional,l.BidirectionalTool),Y(m.SREllipticalROI,l.EllipticalROITool),Y(m.SRCircleROI,l.CircleROITool),Y(m.SRArrowAnnotate,l.ArrowAnnotateTool),Y(m.SRAngle,l.AngleTool),Y(m.SRPlanarFreehandROI,l.PlanarFreehandROITool),Y(m.SRRectangleROI,l.RectangleROITool),Y(m.SRCobbAngle,l.CobbAngleTool);const n={lineDash:"4,4"};l.annotation.config.style.setToolGroupToolStyles("SRToolGroup",{[m.DICOMSRDisplay]:n,SRLength:n,SRBidirectional:n,SREllipticalROI:n,SRCircleROI:n,SRArrowAnnotate:n,SRCobbAngle:n,SRAngle:n,SRPlanarFreehandROI:n,SRRectangleROI:n,global:{}})},getViewportModule:({servicesManager:e,extensionManager:n})=>[{name:"dicom-sr",component:t=>a.createElement(ee,K({servicesManager:e,extensionManager:n},t))}],getCommandsModule:z,getSopClassHandlerModule:$,getUtilityModule:({servicesManager:e})=>[{name:"tools",exports:{toolNames:m}}]}},92522:(e,n,t)=>{t.d(n,{Z:()=>s});const a=t(84793).classes.ImageSet,o=(e,n)=>{const{displaySetInstanceUID:t,ReferencedSOPInstanceUID:a}=e,o=n.getDisplaySetByUID(t);if(o.images)return o.images.find((e=>e.SOPInstanceUID===a))},r=(e,n)=>{const t=[],a={};for(const r of n.measurements){const{imageId:n}=r;if(!n)continue;if(a[n])continue;const s=o(r,e);s?(a[n]=s,t.push(s)):console.log("Measurement",r,"had no instances found")}return t},s=(e,n)=>{const t=r(e,n),o=new a(t),s=t[0];return o.setAttributes({displaySetInstanceUID:o.uid,SeriesDate:s.SeriesDate,SeriesTime:s.SeriesTime,SeriesInstanceUID:o.uid,StudyInstanceUID:s.StudyInstanceUID,SeriesNumber:s.SeriesNumber||0,SOPClassUID:s.SOPClassUID,SeriesDescription:`${n.SeriesDescription} KO ${n.instance.SeriesNumber}`,Modality:"KO",isMultiFrame:!1,numImageFrames:t.length,SOPClassHandlerId:"@ohif/extension-default.sopClassHandlerModule.stack",isReconstructable:!1,isCompositeStack:!0,madeInClient:!0,excludeFromThumbnailBrowser:!0,updateInstances:function(){this.images.splice(0,this.images.length,...r(e,n)),this.numImageFrames=this.images.length}}),e.addDisplaySets(o),o}},83330:(e,n,t)=>{t.d(n,{Z:()=>m});var a=t(12651),o=t(84793);var r=t(91202),s=t(93725);const{locking:i}=s.annotation,{guid:c}=o.default.utils,{MeasurementReport:l,CORNERSTONE_3D_TAG:d}=r.adaptersSR.Cornerstone3D,u="Cornerstone3DTools",S="0.1",g=["cornerstoneTools@^4.0.0"],f=(e,n)=>{if(!n||"CORNERSTONEJS"===n.CodingSchemeDesignator)return;const t=`${n.CodingSchemeDesignator}:${n.CodeValue}`;return{...e[t],ref:t,...n,text:n.CodeMeaning}},I=(e,n)=>{if(!n||!n.length)return;const t=[];for(let a=0;a<n.length;a++){const o=f(e,n[a][0]||n[a]);o&&t.push(o)}return t.length&&t||void 0};function m({servicesManager:e,extensionManager:n,appConfig:t},r){const m=s.annotation.state.getAnnotationManager(),h=t?.disableEditing,C=n.getActiveDataSource()[0],{measurementService:T,displaySetService:D,customizationService:O}=e.services,E=O.getCustomization("codingValues",{}),y=D.getDisplaySetByUID(r),U=T.getSourceMappings(u,S);if(!U||!U.length)throw new Error("Attempting to hydrate measurements service when no mappings present. This shouldn't be reached.");const b=o.DicomMetadataStore.getInstance(y.StudyInstanceUID,y.SeriesInstanceUID,y.SOPInstanceUID),N={},w={};y.measurements.forEach((e=>{const{ReferencedSOPInstanceUID:n,imageId:t,frameNumber:a}=e;N[n]||(N[n]=t,w[n]=[]),w[n][a]||(w[n][a]=t)}));const M=function(e){const n="Imaging Measurements",t="Measurement Group",a="Tracking Identifier",o=p(e.ContentSequence).find(R(n)),r=p(o.ContentSequence).filter(R(t)),s={},i=l.CORNERSTONE_TOOL_CLASSES_BY_UTILITY_TYPE,c=[];return Object.keys(i).forEach((e=>{c.push(i[e]),s[e]=[]})),r.forEach(((e,n)=>{const t=p(e.ContentSequence).find((e=>e.ConceptNameCodeSequence.CodeMeaning===a)),o=t.TextValue;let[r,s]=o.split(":");g.includes(r)&&(r=d);const i=`${r}:${s}`;t.TextValue=i})),e}(b);let v=l.generateToolState(M,N,a.utilities.imageToWorldCoords,a.metaData);const P=O.getModeCustomization("onBeforeSRHydration")?.value;"function"==typeof P&&(v=P({storedMeasurementByAnnotationType:v,displaySet:y}));const A=U.map((e=>e.annotationType)),q={};Object.keys(v).forEach((e=>{A.includes(e)&&(q[e]=v[e])}));const L=[];let k;Object.keys(q).forEach((e=>{q[e].forEach((e=>{const n=e.annotation.data&&e.annotation.data.frameNumber||1,t=w[e.sopInstanceUid][n]||N[e.sopInstanceUid];L.includes(t)||L.push(t)}))}));const V=[];for(let e=0;e<L.length;e++){const n=L[e],{SeriesInstanceUID:t,StudyInstanceUID:o}=a.metaData.get("instance",n);V.includes(t)||V.push(t),k?k!==o&&console.warn("NO SUPPORT FOR SRs THAT HAVE MEASUREMENTS FROM MULTIPLE STUDIES."):k=o}return Object.keys(q).forEach((e=>{q[e].forEach((n=>{const t=n.annotation.data&&n.annotation.data.frameNumber||1,o=w[n.sopInstanceUid][t]||N[n.sopInstanceUid];n.uid=c();const r=a.metaData.get("instance",o),{FrameOfReferenceUID:s}=r,l={annotationUID:n.annotation.annotationUID,data:n.annotation.data,metadata:{toolName:e,referencedImageId:o,FrameOfReferenceUID:s}},d=T.getSource(u,S);l.data.label=function(e){const{findingSites:n=[],finding:t}=e;let a=n.find((e=>"CORNERSTONEFREETEXT"===e.CodeValue));return a?a.CodeMeaning:t&&"CORNERSTONEFREETEXT"===t.CodeValue?t.CodeMeaning:void 0}(n),l.data.finding=f(E,n.finding?.[0]),l.data.findingSites=I(E,n.findingSites),l.data.site=l.data.findingSites?.[0];const g=U.find((n=>n.annotationType===e)),p=T.addRawMeasurement(d,e,{annotation:l},g.toMeasurementSchema,C);if(h){const e=m.getAnnotation(p);i.setAnnotationLocked(e,!0)}L.includes(o)||L.push(o)}))})),y.isHydrated=!0,{StudyInstanceUID:k,SeriesInstanceUIDs:V}}const p=function(e){return Array.isArray(e)?e:[e]},R=e=>n=>n.ConceptNameCodeSequence.CodeMeaning===e},75449:(e,n,t)=>{t.d(n,{l2:()=>r,yR:()=>s});var a=t(12651);const o={TrackingUniqueIdentifier:null,trackingIdentifiersByViewportId:{}};function r(e,n,t=0){const r=(0,a.getEnabledElement)(e),{viewport:s}=r;o.trackingIdentifiersByViewportId[s.id]={trackingUniqueIdentifiers:n,activeIndex:t}}function s(e){const n=(0,a.getEnabledElement)(e),{viewport:t}=n;return o.trackingIdentifiersByViewportId[t.id]?o.trackingIdentifiersByViewportId[t.id]:{trackingUniqueIdentifiers:[]}}}}]);
//# sourceMappingURL=7360.bundle.03363420181afb9e0410.js.map